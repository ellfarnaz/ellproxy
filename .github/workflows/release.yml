name: Build and Release (Code Signed)

on:
  push:
    tags:
      - "v*" # Triggers on version tags like v1.0.0
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  build-signed:
    name: Build and Sign macOS App
    runs-on: macos-14 # macOS Sonoma on Apple Silicon (M1)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9"

      # Import Apple Developer certificates (SKIPPED - No Apple Developer Account)
      # - name: Import Code Signing Certificates
      #   uses: apple-actions/import-codesign-certs@v2
      #   with:
      #     p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
      #     p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}

      # Install the provisioning profile (if needed for distribution)
      # Note: Not typically needed for Developer ID distribution
      # - name: Install Provisioning Profile
      #   if: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 != '' }}
      #   run: |
      #     PP_PATH=$RUNNER_TEMP/profile.provisionprofile
      #     echo -n "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode -o $PP_PATH
      #     mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
      #     cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION} (build ${BUILD_NUMBER})"

      - name: Build app bundle (unsigned)
        env:
          APP_VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          chmod +x create-app-bundle.sh
          ./create-app-bundle.sh
          echo "✅ App built with ad-hoc signature (unsigned)"

      # Verify the signing (SKIPPED - ad-hoc signature only)
      # - name: Verify Code Signature
      #   run: |
      #     codesign --verify --deep --strict --verbose=2 EllProxy.app
      #     codesign -dv --verbose=4 EllProxy.app
      #     spctl -a -vvv -t install EllProxy.app || echo "⚠️ Gatekeeper check failed (expected without notarization)"

      # Notarize the app (SKIPPED - requires Apple Developer Account)
      # Users will need to right-click > Open to bypass Gatekeeper

      - name: Create DMG
        run: |
          # Install create-dmg tool
          brew install create-dmg

          # Create DMG
          create-dmg \
            --volname "EllProxy" \
            --volicon "icon.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "EllProxy.app" 175 120 \
            --hide-extension "EllProxy.app" \
            --app-drop-link 425 120 \
            --codesign "${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}" \
            "EllProxy.dmg" \
            "EllProxy.app" || true

          # Verify DMG was created and signed
          if [ -f "EllProxy.dmg" ]; then
            echo "✅ DMG created successfully"
            codesign -dv "EllProxy.dmg" || echo "⚠️ DMG not signed (non-fatal)"
          fi

      - name: Create ZIP archive
        run: |
          # ZIP is more reliable for GitHub releases
          ditto -c -k --sequesterRsrc --keepParent "EllProxy.app" "EllProxy.zip"

      - name: Calculate checksums
        run: |
          shasum -a 256 EllProxy.zip > EllProxy.zip.sha256
          if [ -f "EllProxy.dmg" ]; then
            shasum -a 256 EllProxy.dmg > EllProxy.dmg.sha256
          fi

      # Sign update for Sparkle (SKIPPED - requires Sparkle private key)
      # Auto-update feature will not work without this signature
      # - name: Sign update for Sparkle
      #   id: sparkle_sign
      #   env:
      #     SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
      #   run: |
      #     SIGN_UPDATE=$(find src/.build -name "sign_update" -type f | grep -v old_dsa | head -1)
      #     if [ -z "$SIGN_UPDATE" ]; then
      #       echo "Error: sign_update not found"
      #       exit 1
      #     fi
      #     SIGNATURE=$(echo "$SPARKLE_PRIVATE_KEY" | "$SIGN_UPDATE" EllProxy.zip --ed-key-file -)
      #     ED_SIGNATURE=$(echo "$SIGNATURE" | grep -o 'sparkle:edSignature="[^"]*"' | sed 's/sparkle:edSignature="//;s/"$//')
      #     LENGTH=$(stat -f%z EllProxy.zip)
      #     echo "ed_signature=$ED_SIGNATURE" >> $GITHUB_OUTPUT
      #     echo "length=$LENGTH" >> $GITHUB_OUTPUT

      # Update appcast.xml (SKIPPED - requires Sparkle signature)
      # - name: Update appcast.xml
      #   env:
      #     VERSION: ${{ steps.get_version.outputs.VERSION }}
      #     BUILD_NUMBER: ${{ steps.get_version.outputs.BUILD_NUMBER }}
      #   run: |
      #     echo "Skipping appcast.xml update (no Sparkle signature)"

      # Commit appcast.xml (SKIPPED)
      # - name: Commit appcast.xml
      #   run: |
      #     echo "Skipping appcast.xml commit"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            EllProxy.zip
            EllProxy.zip.sha256
            EllProxy.dmg
            EllProxy.dmg.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## EllProxy ${{ steps.get_version.outputs.VERSION }}

            ### Installation

            **Option 1: ZIP (Recommended)**
            1. Download `EllProxy.zip`
            2. Extract the file
            3. Drag `EllProxy.app` to your `/Applications` folder
            4. Double-click to launch

            **Option 2: DMG**
            1. Download `EllProxy.dmg`
            2. Double-click to mount
            3. Drag `EllProxy.app` to the Applications folder
            4. Eject the DMG
            5. Launch EllProxy from Applications

            ### What's New

            See the [CHANGELOG](https://github.com/ellfarnaz/ellproxy/blob/main/CHANGELOG.md) for details.

            ### ⚠️ Important: Unsigned Build

            This release is **unsigned** (no Apple Developer account). 

            **On first launch:**
            1. Do NOT double-click the app
            2. Right-click `EllProxy.app` → Click **"Open"**
            3. Click **"Open"** in the security dialog
            4. After first launch, you can double-click normally

            ### Verification

            SHA-256 checksums are included for file integrity verification:
            ```bash
            shasum -a 256 -c EllProxy.zip.sha256
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (for manual downloads)
        uses: actions/upload-artifact@v4
        with:
          name: EllProxy-macOS-Signed
          path: |
            EllProxy.zip
            EllProxy.dmg
          retention-days: 30
